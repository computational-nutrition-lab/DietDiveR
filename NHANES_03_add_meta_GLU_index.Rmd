---
title: "Add metadata and GLU-index"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
# code_folding: hide
---

<style type="text/css">
h1.title {
  font-size: 38px;
  font-family: "Tahoma", sans-serif;
  color: #1F3600; /* darkgreen from DietDiveR logo */
}
h1 { /* Header 1 */
  font-size: 28px;
  color: #1F3600;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: #1F3600;
}
h3 { /* Header 3 */
  font-size: 18px;
  color: #1F3600;
}
body{ /* Normal  */
  background-color: rgb(251, 251, 251);
  }
blockquote{ 
  font-size: 14px;
}
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #1F3600;
}
</style>

<br>

# Introduction

In this script, we will add participantsâ€™ metadata, and GLU_index variable based on their blood glucose levels.

<br>

# Load functions and packages

Name the path to DietDiveR directory where input files are pulled.
```{r}
  main_wd <- "~/GitHub/DietDiveR"
```

Install the foreign package if it is not installed yet.
```{r, eval=FALSE}
if (!require("foreign", quietly = TRUE)) install.packages("foreign")
```

<!-- Load foreign in the background -->
```{r, echo=FALSE}
library(foreign)
```

Load the necessary functions.
```{r}
source("lib/specify_data_dir.R")
source("lib/load_clean_NHANES.R")
source("lib/add_gender_and_age.R")
```

You can come back to the main directory by:
```{r, eval=FALSE}
setwd(main_wd)
```

Specify the directory where the data is.
```{r, eval = FALSE}
SpecifyDataDirectory(directory.name= "eg_data/NHANES/")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_knit$set(root.dir = 'eg_data/NHANES')
```

<br>

Create a folder called "Laboratory_data" under "NHANES", so that our results with laboratory data (glucose tolerance test) can be saved.

<br>

# Load NHANES15-16totals with demographic data

Load the QC-ed total (with food categories), filtered for KCAL, PROT, TFAT, VC. 4,164 people.
```{r}
QCtotal_d <- read.table("Total_D12_FC_QC_mean_QC_demo.txt", sep="\t", header=T)
```

Check the number of participants in the QCtotals - should be 4,164 people.
```{r}
length(unique(QCtotal_d$SEQN))
```

# Add Gender and Age, body measure, and metadata

We are going to use the following columns:  
RIAGENDR = gender  
RIDAGEYR = age
  
Add gender and age_groups to QCtotal_d_glu_body_meta. The output is named "totals_out".
```{r}
AddGenderAgeGroups(input=QCtotal_d, age.col="RIDAGEYR", gender.col="RIAGENDR")
```

Rename the output as QCtotal_d_ga.
```{r}
QCtotal_d_ga <- totals_out  
```

Ensure grouping has been done correctly.
```{r}
head(QCtotal_d_ga[, c("RIAGENDR", "Gender", "RIDAGEYR", "AgeGroup", "Gender_Age")])
```

Check the frequency of the groups. As expected, people aged 18-19 are less frequent.
```{r}
table(QCtotal_d_ga$Gender_Age)  
table(QCtotal_d_ga$AgeGroup)    
```

<br>

# Add body measure data

Download the body measure data from NHANES website and save it in "Raw_data" folder.
```{r,eval=FALSE}
download.file("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/BMX_I.XPT", 
              destfile= "Raw_data/BMX_I.XPT", mode="wb")  
```

Load the body measure data.
```{r}
bodymea <- read.xport("Raw_data/BMX_I.XPT")
```

Explanation of variables can be found from [NHANES](https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/BMX_I.htm).
  
Relevant variables here include:  

Variable | Description
--------- | ---------------------------------
BMDSTATS | Body Measures Component Status Code. 1 == Complete data for age group; 2 ==	Partial: Only height and weight obtained.
BMXHT    | Standing Height (cm)
BMIHT    | Standing Height Comment
BMXBMI   | Body Mass Index (kg/m^2^)
BMXWAIST | Waist Circumference (cm)

Add body measure to `QCtotal_d`.
```{r}
QCtotal_d_ga_body <- merge(x=QCtotal_d_ga, y=bodymea, by="SEQN")
```

<br>

---

Download the metadata for people, who are in Total Day 1 from the NHANES website, and save it in "Raw_data" folder.
```{r,eval=FALSE}
download.file("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DR1TOT_I.XPT", 
              destfile= "Raw_data/DR1TOT_I.XPT", mode="wb")  
```

Load the metadata in Total Day 1.
```{r}
metadata_raw <- read.xport("Raw_data/DR1TOT_I.XPT")
```

Total Day 1 has "dietary data for day 1" and "metadata", but we only need the metadata; thus, take out only the metadata columns (variables) and exclude the day 1 data. Column names' descriptions can be found here on the [NHANES 2015-16 page](https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DR1TOT_I.htm).

First, specify the first and the last column names to select.  
Look for the column number that matches the first and last variable specified.  
```{r}
sta_col_num_a <- match("DBQ095Z"  , names(metadata_raw))  # Salt-related questions
end_col_num_a <- match("DRQSPREP" , names(metadata_raw))
sta_col_num_b <- match("DRQSDIET" , names(metadata_raw))  # Diet-related questions
end_col_num_b <- match("DRQSDT91" , names(metadata_raw))
sta_col_num_c <- match("DRD340"   , names(metadata_raw))  # Fish-related questions
end_col_num_c <- match("DRD370V"  , names(metadata_raw))
```

Only select the metadata variables and SEQN, which is in column 1.
```{r}
metadata_only <- metadata_raw[, c(1,
                                  sta_col_num_a:end_col_num_a,
                                  sta_col_num_b:end_col_num_b,
                                  sta_col_num_c:end_col_num_c
                                  )]
```

Check that this has only the SEQN and metadata columns.
```{r}
colnames(metadata_only)
```

Add meatadata to `QCtotal_d_glu_body`.
```{r}
QCtotal_d_ga_body_meta <- merge(x=QCtotal_d_ga_body, y=metadata_only, by="SEQN")
```

Save as a .txt file.  This can be used for answering research questions other than glycaemic index.
```{r}
write.table(QCtotal_d_ga_body_meta, "Total_D12_FC_QC_mean_QC_demo_ga_body_meta.txt",
            sep="\t", row.names=F, quote=F)
```

<br>

# Load the blood glucose data, add GLU_index, and filter out rows containing missing data

Download the blood glucose data from NHANES website, and save it in "Raw_data" folder.
```{r, eval=FALSE}
download.file("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/GLU_I.XPT", 
              destfile= "Raw_data/GLU_I.XPT", mode="wb")  
```

Load the blood glucose data and see.
```{r}
glu <- read.xport("Raw_data/GLU_I.XPT")
```

glu has LBXGLU - Fasting Glucose (mg/dL).
```{r}
head(glu)
```

Check its distribution.
```{r,out.width="60%"}
hist(glu$LBXGLU)
```

Add glu to QCtotal_d_ga_body_meta.
```{r}
QCtotal_d_ga_body_meta_glu <- merge(x=QCtotal_d_ga_body_meta, y=glu, by="SEQN")
```

<br>

---

## Add GLU_index according to their glucose level: Normal, Prediabetic, and Diabetic.
GLU_index | Criteria
--------- | -----------------
Normal    | 99 mg/dL or lower  
Prediabetic | 100 to 125 mg/dL  
Diabetic   | 126 mg/dL or higher  
  
If LBXGLU is missing, put "NA"; if it has a value, add GLU_index category in "GLU_index" column.
```{r}
QCtotal_d_ga_body_meta_glu$GLU_index <- ifelse(
  
  # test sentence
  is.na(QCtotal_d_ga_body_meta_glu$LBXGLU) == TRUE,
  
  # if LBXGLU is NA, put NA to GLU_index column. 
  NA,
  
  # Otherwise, put "Normal", "Prediabetic" or "Diabetic" to GLU_index column. 
  ifelse(QCtotal_d_ga_body_meta_glu$LBXGLU < 100,
         "Normal", 
         ifelse(QCtotal_d_ga_body_meta_glu$LBXGLU < 126,
                "Prediabetic",
                "Diabetic"))
)
```


Check the first 30 rows of glucose and GLU_index columns in QCtotal_d_glu_body_meta.
```{r}
QCtotal_d_ga_body_meta_glu[1:30, c("LBXGLU", "GLU_index")]
```

<br>

---

There are some missing data, so check the frequency with useNA argument to show NAs.
```{r}
table(QCtotal_d_ga_body_meta_glu$GLU_index, useNA="always")
```

Select individuals that have no missing data in the LBXGLU column.
```{r}
QCtotal_d_ga_body_meta_glu_comp <-  QCtotal_d_ga_body_meta_glu[!is.na(QCtotal_d_ga_body_meta_glu$LBXGLU), ]
```

Check the number of rows - should have 1,923 rows.
```{r}
nrow(QCtotal_d_ga_body_meta_glu_comp)
```

Double-check there is no missing data in GLU_index.
```{r}
table(QCtotal_d_ga_body_meta_glu_comp$GLU_index, useNA="always")
```

<br>

# Exclude individuals who are following special diets

There may be some participants following special diets such as low-sodium or gluten-free. Detailed explanation about the special diet question can be found on the [documentation](https://wwwn.cdc.gov/nchs/nhanes/search/variablelist.aspx?Component=Dietary&Cycle=2015-2016).  
  
For this demonstration, we will select only those who are eating freely without following any diet.  

Check the number of individuals who are following any specific diet (DRQSDIET==1).
```{r}
table(QCtotal_d_ga_body_meta_glu_comp$DRQSDIET, useNA="always")
```

DRQSDIET==1 is following a special diet, so select only rows with DRQSDIET==2.
```{r}
QCtotal_d_ga_body_meta_glu_comp_2 <- subset(QCtotal_d_ga_body_meta_glu_comp, DRQSDIET == 2)
```

How many people remained? -- 1,610 remained.
```{r}
table(QCtotal_d_ga_body_meta_glu_comp_2$DRQSDIET)
```

Check the sample size of each category.
```{r}
table(QCtotal_d_ga_body_meta_glu_comp_2$GLU_index, useNA="always")
```

Save the dataset as a .txt file in the folder called "Laboratory_data".
```{r}
write.table(QCtotal_d_ga_body_meta_glu_comp_2, file="Laboratory_data/QCtotal_d_ga_body_meta_glu_comp_2.txt",
            sep= "\t", row.names=F, quote= F)
```

<br>

---

Come back to the main directory before you start running another script.
```{r, eval=FALSE}
  setwd(main_wd)
```

<!-- This is to remove big white space at the end of the rendered html, which is produced due to toc_floating.  Source: https://stackoverflow.com/questions/52933437/how-to-remove-white-space-at-the-end-of-an-rmarkdown-html-output -->
<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
