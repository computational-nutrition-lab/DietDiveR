---
title: "Subset males 60-79 years old"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
# code_folding: hide
---

<style type="text/css">
h1.title {
  font-size: 38px;
  font-family: "Tahoma", sans-serif;
  color: #1F3600; /* darkgreen from DietDiveR logo */
}
h1 { /* Header 1 */
  font-size: 28px;
  color: #1F3600;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: #1F3600;
}
h3 { /* Header 3 */
  font-size: 18px;
  color: #1F3600;
}
body{ /* Normal  */
  background-color: rgb(251, 251, 251);
  }
blockquote{ 
  font-size: 14px;
}
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #1F3600;
}
</style>

<br>

# Introduction

In the previous script, we identified males in their 60s and older seem to be an appropriate subsample to analyze their diabetic statuses and diet. We will remove people who are 80 years old or potentially above from our analyses because they may be using meal assistance and thus may not be eating freely.

<br>

# Load functions and packages  

Name the path to DietDiveR directory where input files are pulled.
```{r}
main_wd <- "~/GitHub/DietDiveR"
```

Load necessary packages.
```{r}
library(ggplot2)
```

Load the necessary functions.
```{r}
source("lib/specify_data_dir.R")
source("lib/ggplot2themes.R")
```

You can come back to the main directory by:
```{r, eval=FALSE}
setwd(main_wd)
```

<br>

# Load NHANES15-16totals data

Specify the directory where the data is.
```{r, eval=FALSE}
SpecifyDataDirectory(directory.name = "eg_data/NHANES/Laboratory_data")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_knit$set(root.dir = 'eg_data/NHANES/Laboratory_data')
```

Load the data of those to be used in the diabetes status analysis.
```{r}
glu_2 <- read.delim(file="QCtotal_d_ga_body_meta_glu_comp_2.txt", sep="\t", header=T)
```

Make GLU_index as a factor for plotting.
```{r}
glu_2$GLU_index <- factor(glu_2$GLU_index, levels = c("Normal", "Prediabetic", "Diabetic"))
```

Check the sample size of each category.
```{r}
table(glu_2$GLU_index, useNA = "always")
```

Age - no missing data, and spread pretty evenly.
```{r}
summary(glu_2$RIDAGEYR)     
```

```{r,out.width="60%"}
hist(glu_2$RIDAGEYR)
```

Gender - no missing data. 1: male, 2: female.
```{r}
table(glu_2$RIAGENDR, useNA="always")     
```

<br>

# Select only males 60-79 years old, so that our samples are more uniform

Select those who are males and whose ages fall between 60-79.
```{r}
glu_2_males60to79 <- subset(glu_2, RIAGENDR == 1 & RIDAGEYR >= 60 & RIDAGEYR <= 79) 
```

Check the dimension of the selected data - 236 rows.
```{r}
dim(glu_2_males60to79)
```

Ensure the ages of the selected subpopulation are between 60-79.
```{r}
table(glu_2_males60to79$RIDAGEYR)
```

Look at the distribution of GLU_index among the selected subpopulation.
```{r}
table(glu_2_males60to79$GLU_index, useNA="always")
```

Save the glu_2_males60to79 as a txt file.
```{r}
write.table(glu_2_males60to79, "QCtotal_d_ga_body_meta_glu_comp_2_males60to79.txt", 
            sep="\t", row.names = F, quote = F)
```

<br>

# Body measurements by diabetic statuses

## BMI

### Look at the BMI frequency of each group

It is OK to see an error saying it removed rows containing non-finite values or missing values,as long as the charts are produced.
```{r}
males60to79_BMIfreq <- 
  ggplot(data=glu_2_males60to79, aes(x=BMXBMI, group=GLU_index, fill=GLU_index)) +
  geom_density(adjust=1.5, alpha=0.4) + space_axes + no_grid +
  scale_fill_manual(values= c("aquamarine2", "lightgoldenrod1", "lightpink1") ) +
  labs(x="BMI", y="Density")
```

```{r,out.width="60%"}
males60to79_BMIfreq
```

Save the chart as .pdf.
```{r}
ggsave("males60to79_BMI_by_GLU_index.pdf", 
       males60to79_BMIfreq, device="pdf", width=5.3, height=4.5)
```

<br>

---

### Create a boxplot of BMI of each GLU_index group

```{r}
males60to79_BMIbox <- 
  ggplot(glu_2_males60to79, aes(x=GLU_index, y=BMXBMI, fill=GLU_index)) +
  geom_boxplot(outlier.shape = NA) + no_grid + space_axes +
  scale_fill_manual(values= c("aquamarine2", "lightgoldenrod1", "lightpink1") ) +
  geom_jitter(width=0.3)
```

```{r,out.width="60%"}
males60to79_BMIbox
```

```{r}
ggsave("males60to79_BMI_by_GLU_index_box.pdf", 
       males60to79_BMIbox, device="pdf", width=5.3, height=4.5)
```

<br>

---

### ANOVA between groups

The three GLU_index groups appear to have different BMI means. 

Test the difference between groups by ANOVA.

Remove samples (rows) that have missing data in the target variable.
```{r}
df <- glu_2_males60to79[complete.cases(glu_2_males60to79$BMXBMI), ]
```

Run ANOVA.
```{r}
myanova <- aov(BMXBMI ~ GLU_index, data=df)
summary(myanova)
```

The ANOVA results indicate that the groups are different (p<0.05).

But first, test the assumptions for ANOVA.

Create a new dataset of residuals of the model.
```{r}
res1 <- residuals(myanova)
```

Check the normality assumption.
```{r,out.width="60%"}
hist(res1)
```

```{r,out.width="60%"}
qqnorm(res1, plot.it=TRUE)
qqline(res1)
```

The histogram and QQplot indicate the residuals have an approximately normal distribution. 

check equal variance of residuals with a side-by-side boxplots of the residuals.
```{r,out.width="60%"}
boxplot(res1 ~ df$GLU_index)
```

This boxplot also indicates the variance of the residuals are approximately equal across the factor levels.

Create a new variable of squared residuals.
```{r}
res1sq <- res1*res1
```

Levene's test -- Run ANOVA for the squared residuals as the response.  
If Pr>0.05, the residuals of the groups have equal variance.
```{r}
anova(lm(res1sq ~ df$GLU_index))
```

The p-value (Pr) of the Levene's test also supported equal variance.

When the assumptions are satisfied, then you can run ANOVA.
```{r}
summary(aov(BMXBMI ~ GLU_index, data=df))
```

If ANOVA is significant, you can do a pairwise t-test.

"holm" (default) is less conservative than Bonferroni p-value adjustment method for multiple comparisons. Other methods that can be used: "holm", "hochberg", "hommel", "bonferroni", "BH", "BY", "fdr", "none".
```{r}
pairwise.t.test(df$BMXBMI, df$GLU_index, p.adjust.method = "holm") 
```

Based on the p-values, Normal and Prediabetic have the same mean BMI (p=0.12765 > 0.05). Normal and Diabetic have different mean BMI (p=0.00037 < 0.05), as do Prediabetic and Diabetic (p=0.00324 < 0.05).     

<br>

---

## KCAL

### Look at the KCAL frequency of each group

```{r}
males60to79_KCALfreq <- 
  ggplot(data=glu_2_males60to79, aes(x=KCAL, group=GLU_index, color=GLU_index)) +
  geom_density(adjust=1.5, alpha=0.4, linewidth=1.2, linetype="longdash") + space_axes + no_grid +
  scale_color_manual(values= c("aquamarine3", "lightgoldenrod3", "lightpink1")) +
  labs(x="KCAL", y="Density") +
  scale_y_continuous(labels= function(x) format(x, scientific = FALSE))
```

```{r,out.width="60%"}
males60to79_KCALfreq
```

Save the chart as .pdf.
```{r}
ggsave("males60to79_KCAL_by_GLU_index.pdf", 
       males60to79_KCALfreq, device="pdf", width=5.3, height=4.5)
```

<br>

---

### Create a boxplot of KCAL of each GLU_index group

```{r}
males60to79_KCALbox <- 
  ggplot(glu_2_males60to79, aes(x=GLU_index, y=KCAL, fill=GLU_index)) +
  geom_boxplot(outlier.shape = NA) + no_grid + space_axes +
  scale_fill_manual(values= c("aquamarine2", "lightgoldenrod1", "lightpink1") ) +
  geom_jitter(width=0.3)
```

```{r,out.width="60%"}
males60to79_KCALbox
```

```{r}
ggsave("males60to79_KCAL_by_GLU_index_box.pdf", 
       males60to79_KCALbox, device="pdf", width=5.3, height=4.5)
```

<br>

---

### ANOVA between groups

Test the difference of KCAL between groups by ANOVA.

Remove samples (rows) that have missing data in the target variable.
```{r}
df <- glu_2_males60to79[complete.cases(glu_2_males60to79$KCAL), ]
```

Run ANOVA.
```{r}
summary(aov(KCAL ~ GLU_index, data=df))
```

Based on the p-values for ANOVA, the energy intake in KCAL is not different between the GLU_index groups are not different.    

<br>  

---

Come back to the main directory.
```{r, eval=FALSE}
setwd(main_wd)
```

<!-- This is to remove big white space at the end of the rendered html, which is produced due to toc_floating.  Source: https://stackoverflow.com/questions/52933437/how-to-remove-white-space-at-the-end-of-an-rmarkdown-html-output -->
<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
