---
title: "Generate foodtrees from your data"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
# code_folding: hide
---

<style type="text/css">
h1.title {
  font-size: 38px;
  font-family: "Tahoma", sans-serif;
  color: #1F3600; /* darkgreen from DietDiveR logo */
}
h1 { /* Header 1 */
  font-size: 28px;
  color: #1F3600;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: #1F3600;
}
h3 { /* Header 3 */
  font-size: 18px;
  color: #1F3600;
}
body{ /* Normal  */
  background-color: rgb(251, 251, 251);
  }
blockquote{ 
  font-size: 14px;
}
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #1F3600;
}
</style>

<br>

# Introduction

In this script, we will build a foodtree with the NHANES 2-day average totals, subsetted for males, 60-79 years old. 

First, we will load the QC-ed averaged totals of males 60-79 years old (n=236) and all food records (n=4,164). Then, we will keep the food records of only the individuals in males 60-79 years old and generate a foodtree with the filtered food data. 

<br>

# Load functions and packages  

Name the path to DietDiveR directory where input files are pulled.
```{r}
main_wd <- "~/GitHub/DietDiveR"
```

Load the reshape2 package necessary for tree building, and if it is not installed, install it. 
```{r}
if (!require("reshape2", quietly = TRUE))install.packages("reshape2")
```

Load the data.tree package necessary for newick.tree.r, and if it is not installed, install it. 
```{r}
if (!require("data.tree", quietly = TRUE))install.packages("data.tree")
```

Load the necessary functions.
```{r}
source("lib/specify_data_dir.R")

source("lib/Food_tree_scripts/newick.tree.r")
source("lib/Food_tree_scripts/make.food.tree.r") # This needs 'newick.tree.r' already loaded.
source("lib/Food_tree_scripts/make.food.ifc.r")
source("lib/Food_tree_scripts/make.fiber.ifc.r")
source("lib/Food_tree_scripts/make.dhydrt.ifc.r")
```

You can come back to the main directory by:
```{r, eval=FALSE}
setwd(main_wd)
```

<br>

# Load and prep data for generating foodtrees

Specify the directory where the data is.
```{r, eval=FALSE}
SpecifyDataDirectory(directory.name = "eg_data/NHANES/Laboratory_data")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_knit$set(root.dir = 'eg_data/NHANES/Laboratory_data')
```

<br>

Load the males60to79 people. Note this is a total data (1 row/person).
```{r}
totals_males60to79 <- read.table("QCtotal_d_ga_body_meta_glu_comp_2_males60to79.txt", 
                                 sep="\t", header=T)
```

Make the individuals as a vector.
```{r}
selectedind <- totals_males60to79$SEQN
```

Load the input file (all food record data) to be filtered.
```{r}
all.food.record <- read.table("../Food_D12_FC_QC_demo_QCed.txt", sep="\t", header=T)
```

Select only the individuals listed in `selectedind`.
```{r}
sel.food.record <- all.food.record[all.food.record$SEQN %in% selectedind, ]
```

Confirm the two contains the same set of individuals.
```{r}
identical(unique(sel.food.record$SEQN), selectedind)
```

Save. This will be the input for the following procedures.
```{r}
write.table(sel.food.record, "Food_D12_FC_QC_demo_QCed_males60to79.txt", 
            sep="\t", row.names=F, quote=F) 
```

<br>

# Create foodtrees

Create a foodtree with the foods classified at a desired level of classification (Lv. 1-6).

"NodeLabelsMCT.txt" has a list of food levels and names, which comes with the DietDiveR package.

```{r}
MakeFoodTree(nodes_fn= "../../Food_tree_eg/NodeLabelsMCT.txt", 
             addl_foods_fn = NULL,
             num_levels = 3,
             food_database_fn =            "Food_D12_FC_QC_demo_QCed_males60to79.txt",  
             output_tree_fn =     "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.nwk", 
             output_taxonomy_fn = "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.tax.txt")
```

Arguments | Description
--------- | -----------
nodes_fn | he food level (node) information for each food item
addl_foods_fn | List of foods not present in the list can be added. NULL by default 
num_levels | Number of food levels (1 - 5) to save
food_database_fn | Your food item data
output_tree_fn | Output tree file name. Should end with ".nwk"
output_taxonomy_fn | Output taxonomy file (to be used later) name

The xxx.nwk is the foodtree, and xxx.tax.txt is the taxonomy file that is to be used to IFC tables next.

<br>

# Generate IFC tables for downstream analyses.

Note that this may take some time.

Make the standard food ifc table with data in gram weights of food.
For the food_records_fn argument, you need to supply `sel.food.records` file that have FoodAmt column.

It is OK to see see a warning message: 
"In write.table(dhydrt.ifc, output_fn, sep = "\t", quote = F, append = TRUE) :  
 appending column names to file"

```{r}
MakeFoodIfc(food_records_fn=  "Food_D12_FC_QC_demo_QCed_males60to79.txt",   
            food_record_id =  "SEQN",                              
            food_taxonomy_fn= "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.tax.txt",       
            output_fn =       "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.food.ifc.txt")  
```

Arguments | Description
--------- | -----------
food_records_fn | Same as food_records_fn in MakeFoodTree
food_record_id |  The colunmname of your participants' ID
food_taxonomy_fn | Taxonomy file produced by MakeFoodTree
output_fn | Name output ifc file to be saved

<br>

Make a food ifc table with data in grams of fiber per food.
```{r}
MakeFiberIfc(food_records_fn=  "Food_D12_FC_QC_demo_QCed_males60to79.txt", 
             food_record_id=   "SEQN", 
             food_taxonomy_fn= "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.tax.txt", 
             output_fn=        "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.fiber.ifc.txt")
```

<br>

Make a food ifc table as dehydrated grams per kcal.
```{r}
MakeDhydrtIfc(food_records_fn=  "Food_D12_FC_QC_demo_QCed_males60to79.txt", 
              food_record_id =  "SEQN", 
              food_taxonomy_fn= "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.tax.txt", 
              output_fn =       "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.dhydrt.ifc.txt")  
```


<br>  

---

Come back to the main directory.
```{r, eval=FALSE}
setwd(main_wd)
```

<!-- This is to remove big white space at the end of the rendered html, which is produced due to toc_floating.  Source: https://stackoverflow.com/questions/52933437/how-to-remove-white-space-at-the-end-of-an-rmarkdown-html-output -->
<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
