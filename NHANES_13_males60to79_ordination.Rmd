---
title: "Perform ordination"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
# code_folding: hide
---

<style type="text/css">
h1.title {
  font-size: 38px;
  font-family: "Tahoma", sans-serif;
  color: #1F3600; /* darkgreen from DietDiveR logo */
}
h1 { /* Header 1 */
  font-size: 28px;
  color: #1F3600;
}
h2 { /* Header 2 */
    font-size: 22px;
  color: #1F3600;
}
h3 { /* Header 3 */
  font-size: 18px;
  color: #1F3600;
}
body{ /* Normal  */
  background-color: rgb(251, 251, 251);
  }
blockquote{ 
  font-size: 14px;
}
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #1F3600;
}
</style>

<br>

# Introduction

In this script, we will take the phylogeny of food items into account in clustering individuals according to their dietary data. In order to do so, we will use [the phyloseq package](https://joey711.github.io/phyloseq/index.html), which uses phylogeny of microbes and their abundance. We will replace microbes with food items consumed by our dietary study participants.

<br>

# Load functions and packages  

Name the path to DietDiveR directory where input files are pulled.
```{r}
main_wd <- "~/GitHub/DietDiveR"
```

<br>

---

If you have not downloaded and installed the phyloseq package yet, you can do so by first installing BiocManager (if you have not done so):
```{r}
if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager")
```

Then download and install the phyloseq package.
```{r,eval=FALSE}
BiocManager::install("phyloseq")
```

Install the devtools package necessary for installing the pairwiseAdonis package.
```{r}
if (!require("devtools",    quietly = TRUE))install.packages("devtools")
```

Install pairwise adonis function from Github. (https://github.com/pmartinezarbizu/pairwiseAdonis)
```{r,eval=FALSE}
devtools::install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
```

<br>

---

Load necessary packages.
```{r}
library(foreign)
library(vegan)
library(phyloseq)
library(ggplot2)
library(ggtree) # Shows how to cite the ggtree package. Make sure to cite it accordingly.
library(cluster) # necessary to the "pairwiseAdonis" package.
library(pairwiseAdonis)
```

Load the necessary functions.
```{r}
source("lib/specify_data_dir.R")
source("lib/ordination.R")
source("lib/ggplot2themes.R")
source("lib/sort_IFC_by_ID.R")
source("lib/plot.axis.1to4.by.factor.R")

```

Load the distinct 100 colors for use.
```{r}
distinct100colors <- readRDS("lib/distinct100colors.rda")
```

You can come back to the main directory by:
```{r, eval=FALSE}
setwd(main_wd)
```

Specify the directory where the data is.
```{r, eval=FALSE}
SpecifyDataDirectory(directory.name = "eg_data/NHANES/Laboratory_data/")
```

```{r setup_1, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_knit$set(root.dir = 'eg_data/NHANES/Laboratory_data/')
```

<br>

# Create a phyloseq object for ordination
  
## Load files for creating a phyloseq object 

### Food

Load IFC table, and sort the columnnames (userID), leaving the last column (taxonomy) intact. This dataframe will be saved as `food`. Also, save `food` as a .txt file to be used in the "correlation between Axes and foods" section.
```{r}
SortIFCByID(ifc.input =           "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.food.ifc.txt",
            outfn.for.corr.axis = "Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.food.ifc_sorted.txt")
```

`food` is a matrix of Food descriptions (rows) x SampleID (columns).

The column name of "food" is the ordered SEQNs preceded with an 'X'.
```{r}
head(food)[1:6, 1:4]
```

Format the food file and create an ifc_table called IFC.
```{r}
PrepFood(data = food)
```

### Taxonomy (tax)

Load taxonomy file generated by the MakeFoodTree function.
```{r}
tax <- read.delim("Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.tax.txt")
```

Format the tax file and create a taxonomy table called TAX.
```{r}
PrepTax(data=tax)
```

### Sample

Load the demographics data.
```{r}
demog <- read.xport("../Raw_data/DEMO_I.XPT")  
```

Load our dataset that has the "GLU_index" information.
```{r}
glu <- read.delim( file="QCtotal_d_ga_body_meta_glu_comp_2.txt", sep= "\t", header= T )
```

Take out only the SEQN and GLU_index.
```{r}
SEQN_GLU <- glu[, c("SEQN", "GLU_index")]
```

Add GLU_index to metadata.
```{r}
demog_glu <- merge(x=SEQN_GLU, y=demog, all.x=T, by="SEQN")
```

Now, it has GLU_index.
```{r}
head(demog_glu, 2)
```

Add 'X' in front of the SEQN and define it as rownames.
```{r}
rownames(demog_glu) <- paste("X", demog_glu$SEQN, sep="") 
```

Prep metadata for generating a phyloseq object.
```{r}
PrepMeta_NHANES(data = demog_glu)
```

### Foodtree

Load foodtree file generated by the MakeFoodTree function.
```{r}
foodtree <- read_tree("Foodtree/Food_D12_FC_QC_demo_QCed_males60to79_3Lv.nwk")
```

It is OK to see a message that says:  
"Found more than one class "phylo" in cache; using the first, from namespace 'phyloseq'  
Also defined by 'tidytree'"  

Format the food tree and save it as `TREE`.
```{r}
PrepTree(data=foodtree)
```

It is OK to see the same message as the previous line. 

<br>

## Create a phyloseq object with IFC, TAX, SAMPLES, and TREE
```{r}
phyfoods <- phyloseq(IFC, TAX, SAMPLES, TREE)
```

It is OK to see the same message as the previous line. They may appear multiple times. 

Check your metadata by using the functions in the phyloseq package.
Show the sample names. Change n to adjust the number of rows to show.
```{r}
head(sample_names(phyfoods), n=6)  
```

Show their metadata.
```{r}
head(sample_data(phyfoods), n=4)
```

Show only the columns (variables) of metadata.
```{r}
sample_variables(phyfoods)
```

Check the level 1 foods in your food tree.
```{r}
L1s <- tax_table(phyfoods)[, "L1"]
as.vector(unique(L1s))
```

The L1 categories that are included in your dataset will be shown here. The following analysis (food tree and ordination) assumes that your dataset has at least one food in each of the nine L1 categories. Your dataset most likely contains all the nine categories, but if your dataset only contains special diet-adhering subjects, you may need to adjust the source code to accommodate missing L1 categories.

Change to the folder called "Ordination" in your "Ordination" folder.
```{r,eval=FALSE}
SpecifyDataDirectory(directory.name = "eg_data/NHANES/Laboratory_data/Ordination/")
```

```{r setup_2, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_knit$set(root.dir = 'eg_data/NHANES/Laboratory_data/Ordination/')
```

<br>

# Perform ordination with WEIGHTED unifrac distance

Perform Principal Coordinate Analysis (PCoA) with WEIGHTED unifrac distance of your food data. This may take a few minutes depending on your data size. e.g. a large phyloseq object (7.9 MB) could take a few minutes.
```{r}
ordinated_w <- phyloseq::ordinate(phyfoods, method="PCoA", distance="unifrac", weighted=TRUE) 
```

A warning message may appear saying:  
Warning message:  
 In matrix(tree\$edge[order(tree\$edge[, 1]), ][, 2], byrow = TRUE,  :  
 data length [xxxx] is not a sub-multiple or multiple of the number of rows [xxxx]  
 
This warns that the food tree we are using is not bifurcating. But it is OK, since we do not expect our food trees to be bifurcating.

Save the percent variance explained by the axes as a vector to use in plots.
```{r}
eigen_percent_w <- ordinated_w$values$Relative_eig
```

Save the percent variance explained as a txt file.
```{r}
Eigen(eigen.input = eigen_percent_w, 
      output.fn="Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_WEIGHTED_eigen.txt")
```

<br>

## Plot your ordination results

Merge the first n axes to the metadata and save it as a txt file. The merged dataframe, `meta_usersdf`, will be used for plotting.
```{r}
MergeAxesAndMetadata_NHANES(ord.object= ordinated_w, number.of.axes= 10, meta.data= demog_glu, 
                            output.fn= "Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_WEIGHTED_meta_users.txt")
```

Load the output again for plotting.
```{r}
loaded_glu_w <- read.table("Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_WEIGHTED_meta_users.txt",
                           sep="\t", header=T)
```

Convert the GLU_index as a factor to plot it in order.
```{r}
loaded_glu_w$GLU_index <- factor(loaded_glu_w$GLU_index, levels= c("Normal", "Prediabetic", "Diabetic"))
table(loaded_glu_w$GLU_index)
```

Load the eigenvalues as a vector.
```{r}
eigen_loaded <- read.table("Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_WEIGHTED_eigen.txt", header=T)
```

Make a vector that contains the variance explained.
```{r}
eigen_loaded_vec <- eigen_loaded[, 2]
```

<br>

---

Save Axes 1 & 2, 1 & 3, 2 & 3, 3 & 4, 2 & 4 biplots with and without ellipses with specified confidence interval. The reults are saved with filenames with the specified "prefix_AxisXY.pdf" or "prefix_AxisXY_ellipses.pdf". You need to supply the same number of colors in the order of the factor level to be used. `dot.colors` are for datapoints, and `ellipses.colors` are for ellipses outlines.
```{r}
PlotAxis1to4ByFactor(axis.meta.df    = loaded_glu_w, 
                     factor.to.color = "GLU_index", 
                     eigen.vector    = eigen_percent_w ,
                     dot.colors      = c("steelblue3", "yellow", "hotpink"), 
                     ellipses.colors = c("steelblue3", "gold3", "hotpink"),  
                     ellipses.cflevel = 0.95,
                     out.prefix = "Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_WEIGHTED")
```


<br>

---

## Permanova tests

The GLU_index groups look different. Use beta-diversity and adonis tests to see if they are actually distinct from one another.

Generate a weighted unifrac distance matrix.
```{r}
dist_matrix_w <- phyloseq::distance(phyfoods, method = "wunifrac") # weighted
```

Perform dispersion test.

vegan::betadisper computes centeroids and distance of each datapoint from it.
```{r}
dispr_w <- vegan::betadisper(d=dist_matrix_w, phyloseq::sample_data(phyfoods)$GLU_index)
```

Show the centroids and dispersion of each group.
```{r,out.width="70%"}
plot(dispr_w)
```

The distribution of the dots of each GLU_index group should be the same as in the Axis1 x Axis 2 biplot generated by the PlotAxis1to4ByFactor function.

Use dispr to do a permutation test for homogeneity of multivariate dispersion. The set.seed function ensures the same permutation results will be obtained every time; otherwise, the p-values will slightly differ each run, as it is a permutation test. 
```{r}
set.seed(123)
vegan::permutest(dispr_w, perm = 5000)
```

If p>0.05, which is true in this case, the dispersion of each group are not different, and the assumption for adonis is met. 


Use adonis to test whether there is a difference between groups' composition. i.e., composition among groups (food they consumed) is similar or not.
```{r}
set.seed(123)
vegan::adonis(dist_matrix_w ~ phyloseq::sample_data(phyfoods)$GLU_index, permutations = 5000)
```

The results indicate that the overall adonis is significant (p<0.05). If overall adonis is significant, you can run pairwise adonis to see which group pairs are different.
```{r}
pairwise.adonis(dist_matrix_w, phyloseq::sample_data(phyfoods)$GLU_index, perm = 5000,
                p.adjust.m = "none")  
```

<br>

---

## Save weighted unifrac distance matrix

Generate and save an WEIGHTED unifrac distance matrix of "Samples".
```{r}
WeightedUnifracDis(input.phyloseq.obj = phyfoods, 
                   output.fn = "Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_WEIGHTED_uni_dis.txt")        
```

<br>

# Perform ordination with unweighted unifrac distance

Perform Principal Coordinate Analysis (PCoA) with UNweighted unifrac distance of your food data. This may take a few minutes depending on your data size. e.g. a large phyloseq object (7.9 MB) takes ~ 1 min. 
```{r}
ordinated_u <- phyloseq::ordinate(phyfoods, method="PCoA", distance="unifrac", weighted=FALSE) 
```

Save the percent variance explained by the axes as a vector to use in plots.
```{r}
eigen_percent_u <- ordinated_u$values$Relative_eig
```

Save the percent variance explained as a txt file.
```{r}
Eigen(eigen.input = eigen_percent_u, 
      output.fn="Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_UNweighted_eigen.txt")
```

<br>

## Plot your ordination results

Merge the first n axes to the metadata and save it as a txt file. The merged dataframe, `meta_usersdf`, will be used for plotting.
```{r}
MergeAxesAndMetadata_NHANES(ord.object= ordinated_u, number.of.axes= 10, meta.data= demog_glu, 
                            output.fn= "Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_UNweighted_meta_users.txt")
```

Load the output again for plotting.
```{r}
loaded_glu_u <- read.table("Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_UNweighted_meta_users.txt",
                           sep="\t", header=T)  
```

Convert the GLU_index as a factor to plot it in order.
```{r}
loaded_glu_u$GLU_index <- factor(loaded_glu_u$GLU_index, levels = c("Normal", "Prediabetic", "Diabetic"))
```

Take a look at meta_usersdf_loaded.
```{r}
head(loaded_glu_u, 2)
```

<br>

---

Save Axes 1 & 2, 1 & 3, 2 & 3, 3 & 4, 2 & 4 biplots with and without ellipses with specified confidence interval. The reults are saved with filenames with the specified "prefix_AxisXY.pdf" or "prefix_AxisXY_ellipses.pdf". You need to supply the same number of colors in the order of the factor level to be used. `dot.colors` are for datapoints, and `ellipses.colors` are for ellipses outlines.

**[NOTE]** For the "UNweighted" results, , change the input, eigen vectors, and prefix names accordingly. 
```{r}
PlotAxis1to4ByFactor(axis.meta.df    = loaded_glu_u, 
                     factor.to.color = "GLU_index", 
                     eigen.vector    = eigen_percent_u ,
                     dot.colors      = c("steelblue3", "yellow", "hotpink"), 
                     ellipses.colors = c("steelblue3", "gold3", "hotpink"),  
                     ellipses.cflevel = 0.95,
                     out.prefix = "Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_UNweighted")
```

<br>

---

## Permanova tests

It is not clear from the plots whether The GLU_index groups are different. Use beta-diversity and adonis tests to see if they are they actually distinct from one another.

Generate an UNweighted unifrac distance matrix.
```{r}
dist_matrix_u <- phyloseq::distance(phyfoods, method="unifrac")  # UNweighted
```

Dispersion test and plot

vegan::betadisper computes centeroids and distance of each datapoint from it. 
```{r}
dispr_u <- vegan::betadisper(dist_matrix_u, phyloseq::sample_data(phyfoods)$GLU_index)
```

Can show the centroids and dispersion of each group.
```{r,out.width="70%"}
plot(dispr_u)
```

Use dispr to do a permutation test for homogeneity of multivariate dispersion.
```{r}
set.seed(123)
vegan::permutest(dispr_u, perm = 5000)
```

If p>0.05, which is true in this case, the dispersion of each group are not different, and the assumption for adonis is met.

Use adonis to test whether there is a difference between groups' composition. # i.e., composition among groups (food they consumed) is similar or not.
```{r}
set.seed(123)
vegan::adonis(dist_matrix_u ~ phyloseq::sample_data(phyfoods)$GLU_index, permutations = 5000) 
```

If overall adonis is significant, which is not true in this case, but we will run pairwise adonis for demonstration purposes.

```{r}
pairwise.adonis(dist_matrix_u, phyloseq::sample_data(phyfoods)$GLU_index, perm = 5000,
                p.adjust.m = "none")
```

<br>

---

## Save unweighted unifrac distance matrix

Generate and save an UNweighted unifrac distance matrix of "Samples".
```{r}
UnweightedUnifracDis(input.phyloseq.obj = phyfoods, 
                     output.fn = "Food_D12_FC_QC_demo_QCed_males60to79_3Lv_ord_UNweighted_uni_dis.txt")        
```


<br>  

---

Come back to the main directory.
```{r, eval=FALSE}
setwd(main_wd)
```

<!-- This is to remove big white space at the end of the rendered html, which is produced due to toc_floating.  Source: https://stackoverflow.com/questions/52933437/how-to-remove-white-space-at-the-end-of-an-rmarkdown-html-output -->
<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
